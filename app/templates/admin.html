<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin</title>

<style>
body {
  font-family: monospace;
  background:#111;
  color:#eee;
  padding:16px;
}

nav { margin-bottom:12px; }
nav a { color:#81c784; text-decoration:none; }

h1 { color:#ffd54f; margin-bottom:10px; }
h2 { color:#4fc3f7; margin:14px 0 6px; }

input, textarea, select, button {
  background:#222;
  color:#eee;
  border:1px solid #555;
  font-family: monospace;
  padding:4px 6px;
  font-size:14px;
}

select, input { height:28px; }
textarea { width:100%; height:60px; }

button { cursor:pointer; white-space:nowrap; }

.row {
  display:flex;
  gap:6px;
  align-items:center;
  margin-bottom:6px;
}

.row > * { flex:1; }
.row button { flex:0; }

.box {
  border:1px solid #333;
  padding:10px;
  margin-bottom:12px;
}

.danger { color:#f44336; }
.small { font-size:13px; color:#aaa; }
</style>
</head>

<body>

<nav>
  <a href="/">Inicio</a> | <strong>Admin</strong>
</nav>
<hr>

<h1>ADMIN</h1>

<!-- ================================================= -->
<!-- CREAR -->
<!-- ================================================= -->
<h2>Crear</h2>

<form method="post" action="/admin/category">
  <div class="row">
    <input name="name" placeholder="Nueva categoría" required>
    <button>Crear</button>
  </div>
</form>

<form method="post" action="/admin/subcategory">
  <div class="row">
    <select name="category_id" required>
      {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>
    <input name="name" placeholder="Nueva subcategoría" required>
    <button>Crear</button>
  </div>
</form>

<form method="post" action="/admin/question">
  <div class="row">
    <select id="c_create">
      <option value="">Categoría</option>
      {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>

    <select name="subcategory_id" id="s_create" required disabled>
      <option value="">Subcategoría</option>
    </select>
  </div>

  <textarea name="statement" placeholder="Enunciado (LaTeX permitido)"></textarea>

  <div class="row">
    <input name="answer" placeholder="Respuesta correcta" required>
    <button>Guardar</button>
  </div>
</form>

<hr>

<!-- ================================================= -->
<!-- MODIFICAR / ELIMINAR -->
<!-- ================================================= -->
<h2>Modificar / Eliminar</h2>

<div class="box">

  <div class="row">
    <select id="c_edit">
      <option value="">Categoría</option>
      {% for c in categories %}
        <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>

    <select id="s_edit" disabled>
      <option value="">Subcategoría</option>
    </select>

    <select id="q_edit" disabled>
      <option value="">Pregunta</option>
    </select>
  </div>

  <div class="row">
    <input id="edit_name" placeholder="Nuevo nombre">
    <button onclick="submitRename()">Modificar</button>
    <button class="danger" onclick="submitDelete()">Eliminar</button>
  </div>

  <textarea id="edit_statement" placeholder="Editar enunciado"></textarea>

  <div class="row">
    <input id="edit_answer" placeholder="Editar respuesta">
    <button onclick="submitQuestionEdit()">Guardar cambios</button>
  </div>

  <div class="small">
    • Categoría/Subcategoría → renombrar o eliminar<br>
    • Pregunta → editar contenido o eliminar
  </div>

</div>

<!-- ================================================= -->
<!-- IDS OCULTOS -->
<!-- ================================================= -->
<input type="hidden" id="edit_category_id">
<input type="hidden" id="edit_subcategory_id">
<input type="hidden" id="edit_question_id">

<!-- ================================================= -->
<!-- JS -->
<!-- ================================================= -->
<script>
const tree = {
{% for c in categories %}
  "{{ c.id }}": {
    name: "{{ c.name }}",
    subs: {
      {% for s in c.subcategories %}
      "{{ s.id }}": {
        name: "{{ s.name }}",
        questions: {
          {% for q in s.questions %}
          "{{ q.id }}": {
            statement: "{{ q.statement | replace('\n',' ') }}",
            answer: "{{ q.answer }}"
          },
          {% endfor %}
        }
      },
      {% endfor %}
    }
  },
{% endfor %}
};

// ---------- CREAR ----------
const cCreate = document.getElementById("c_create");
const sCreate = document.getElementById("s_create");

cCreate.onchange = () => {
  sCreate.innerHTML = '<option value="">Subcategoría</option>';
  sCreate.disabled = true;
  if (!tree[cCreate.value]) return;

  Object.entries(tree[cCreate.value].subs).forEach(([id,s])=>{
    let o=document.createElement("option");
    o.value=id; o.textContent=s.name;
    sCreate.appendChild(o);
  });
  sCreate.disabled=false;
};

// ---------- EDITAR ----------
const cE = document.getElementById("c_edit");
const sE = document.getElementById("s_edit");
const qE = document.getElementById("q_edit");

const nameI = document.getElementById("edit_name");
const stI = document.getElementById("edit_statement");
const anI = document.getElementById("edit_answer");

cE.onchange = () => {
  document.getElementById("edit_category_id").value = cE.value;
  document.getElementById("edit_subcategory_id").value = "";
  document.getElementById("edit_question_id").value = "";

  sE.innerHTML='<option value="">Subcategoría</option>';
  qE.innerHTML='<option value="">Pregunta</option>';
  sE.disabled=true; qE.disabled=true;
  nameI.value=""; stI.value=""; anI.value="";

  if (!tree[cE.value]) return;

  Object.entries(tree[cE.value].subs).forEach(([id,s])=>{
    let o=document.createElement("option");
    o.value=id; o.textContent=s.name;
    sE.appendChild(o);
  });
  sE.disabled=false;
  nameI.value = tree[cE.value].name;
};

sE.onchange = () => {
  document.getElementById("edit_subcategory_id").value = sE.value;
  document.getElementById("edit_question_id").value = "";

  qE.innerHTML='<option value="">Pregunta</option>';
  qE.disabled=true;
  nameI.value=""; stI.value=""; anI.value="";

  const s = tree[cE.value]?.subs[sE.value];
  if (!s) return;

  Object.entries(s.questions).forEach(([id,q])=>{
    let o=document.createElement("option");
    o.value=id;
    o.textContent=q.statement.slice(0,40);
    qE.appendChild(o);
  });
  qE.disabled=false;
  nameI.value = s.name;
};

qE.onchange = () => {
  document.getElementById("edit_question_id").value = qE.value;
  const q = tree[cE.value].subs[sE.value].questions[qE.value];
  stI.value = q.statement;
  anI.value = q.answer;
};

// ---------- POST HELPERS ----------
function post(path, data){
  const f=document.createElement("form");
  f.method="post"; f.action=path;
  for (let k in data){
    let i=document.createElement("input");
    i.type="hidden"; i.name=k; i.value=data[k];
    f.appendChild(i);
  }
  document.body.appendChild(f);
  f.submit();
}

// ---------- ACTIONS ----------
function submitRename(){
  const catId = document.getElementById("edit_category_id").value;
  const subId = document.getElementById("edit_subcategory_id").value;
  const name  = nameI.value;

  if (subId)
    post("/admin/subcategory/update",{subcategory_id:subId,name:name});
  else if (catId)
    post("/admin/category/update",{category_id:catId,name:name});
  else
    alert("Selecciona categoría o subcategoría");
}

function submitQuestionEdit(){
  const qId = document.getElementById("edit_question_id").value;
  if (!qId) return alert("Selecciona una pregunta");

  post("/admin/question/update",{
    question_id:qId,
    statement:stI.value,
    answer:anI.value
  });
}

function submitDelete(){
  const qId = document.getElementById("edit_question_id").value;
  const subId = document.getElementById("edit_subcategory_id").value;
  const catId = document.getElementById("edit_category_id").value;

  if (qId)
    post("/admin/question/delete",{question_id:qId});
  else if (subId)
    post("/admin/subcategory/delete",{subcategory_id:subId});
  else if (catId)
    post("/admin/category/delete",{category_id:catId});
  else
    alert("Selecciona algo para eliminar");
}
</script>

</body>
</html>
