<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Entrenamiento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing:border-box; }

body {
  font-family: monospace;
  background:#0e0e0e;
  color:#eee;
  padding:12px;
  margin:0;
}

nav a {
  color:#4fc3f7;
  text-decoration:none;
  margin-right:12px;
  display:inline-block;
  margin-bottom:6px;
}

h1, h2 { color:#ffd54f; }

input, button {
  background:#222;
  color:#eee;
  border:1px solid #555;
  font-family: monospace;
  padding:12px;
  margin-top:10px;
  font-size:16px;
  width:100%;
}

label {
  display:block;
  margin:10px 0;
  cursor:pointer;
}

input[type="radio"] {
  width:auto;
  margin-right:8px;
}

::placeholder { color:#888; }

button { cursor:pointer; }

.box {
  margin-top:20px;
  padding:15px;
  border:1px solid #333;
  max-width:700px;
  margin-left:auto;
  margin-right:auto;
}

.progress {
  color:#aaa;
  font-size:14px;
  margin-bottom:10px;
  font-weight:bold;
}

.ok {
  color:#b9f6ca;
  background:#0f2f1f;
  border:1px solid #1b5e20;
  padding:12px;
  font-weight:bold;
}

.bad {
  color:#ff8a80;
  background:#2a0f12;
  border:1px solid #b71c1c;
  padding:12px;
  font-weight:bold;
}

.bad b {
  color:#ff5252;
  font-size:18px;
}

@media (max-width:600px) {
  h1 { font-size:22px; }
  h2 { font-size:18px; }

  .ok, .bad {
    font-size:18px;
    text-align:center;
    border-width:2px;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>

<nav>
  <a href="/">Inicio</a>
  <a href="/admin">Admin</a>
</nav>

<hr>

<h1>ENTRENAMIENTO</h1>

{% if result %}
<div class="box">
  {% if result.correct %}
    <p class="ok">✔ CORRECTO</p>
  {% else %}
    <p class="bad">✘ INCORRECTO</p>
    <p class="bad">
      RESPUESTA CORRECTA:
      <b>{{ result.expected }}</b>
    </p>
  {% endif %}
</div>
{% endif %}

{% if question %}
<div class="box">

  {% if progress %}
    <div class="progress">
      Pregunta {{ progress.current }} / {{ progress.total }}
    </div>
  {% endif %}

  {% if remaining_time is defined %}
    <div class="progress" id="timer"></div>
  {% endif %}

  <h2>Pregunta</h2>

  <div id="question">
    \[
    {{ question.statement }}
    \]
  </div>

  <form method="post" action="/play/answer">
    <input type="hidden" name="question_id" value="{{ question.id }}">
    <input type="hidden" name="subcategory_id" value="{{ subcategory_id }}">

    {% if question.options and question.options|length > 0 %}

      {% for o in question.options %}
        <label>
          <input
            type="radio"
            name="user_answer"
            value="{{ o.id }}"
            required
          >
          {{ o.text }}
        </label>
      {% endfor %}

    {% else %}

      <input
        name="user_answer"
        autofocus
        placeholder="Tu respuesta"
        required
      >

    {% endif %}

    <button>Responder</button>
  </form>

</div>
{% endif %}

{% if summary %}
<div class="box">
  <h2>Resumen</h2>
  <ul>
    <li>Preguntas: {{ summary.attempts }}</li>
    <li>Aciertos: {{ summary.correct }}</li>
    <li>Errores: {{ summary.attempts - summary.correct }}</li>
    <li>
      Precisión:
      {% if summary.attempts > 0 %}
        {{ (summary.correct / summary.attempts * 100) | round(2) }}%
      {% else %}
        0%
      {% endif %}
    </li>
  </ul>

  <form method="get" action="/">
    <button>Volver al inicio</button>
  </form>
</div>
{% endif %}

<script>
MathJax.typesetPromise();
</script>

<script>
{% if remaining_time is defined and question %}
let remaining = {{ remaining_time }};
const timer = document.getElementById("timer");

const interval = setInterval(() => {
  remaining--;

  if (remaining <= 0) {
    clearInterval(interval);
    fetch("/play/timeout", { method: "POST" })
      .then(r => r.text())
      .then(html => document.documentElement.innerHTML = html);
    return;
  }

  const m = Math.floor(remaining / 60);
  const s = remaining % 60;

  if (remaining < 10) timer.style.color = "#ff5252";
  else if (remaining < 30) timer.style.color = "#ff9100";
  else timer.style.color = "#aaa";

  timer.textContent =
    "Tiempo restante: " + m + ":" + s.toString().padStart(2,"0");
}, 1000);
{% endif %}
</script>

</body>
</html>
